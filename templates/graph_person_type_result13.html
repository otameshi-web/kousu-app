<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>作業種別比較表</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
  .chart-container {
    width: 90%;
    margin: auto;
  }
</style>
</head>
<body>
<h1>{{ user }} の作業種別比較表 ({{ year }}年{{ month }}月)</h1>

<h2>作業時間合計（時間＋工数）</h2>
<div class="chart-container">
  <canvas id="timeChart"></canvas>
</div>

<h2>作業件数（件）</h2>
<div class="chart-container">
  <canvas id="countChart"></canvas>
</div>

<script>
const labels = {{ labels | tojson }};
const timeDatasets = {{ time_datasets | tojson }};
const countDatasets = {{ count_datasets | tojson }};
const tenkenKensaTotalTime = {{ tenken_kensa_total_time | tojson }};
const tenkenKensaTotalCount = {{ tenken_kensa_total_count | tojson }};

// ▼ 時間グラフのオプション
const timeOptions = {
  responsive: true,
  plugins: {
    legend: { position: 'top' },
    datalabels: {
      anchor: 'end',
      align: 'end',
      color: 'black',
      formatter: (value, context) => {
        if (value === 0) return '';
        const dataset = context.chart.data.datasets[context.datasetIndex];
        const label = dataset.label || '';

        // 「点検及び検査」の積み上げ棒の最上段にのみ合計を出す
        if (label === "点検（残り）（時間）" && labels[context.dataIndex] === "点検及び検査") {
          return `${tenkenKensaTotalTime}h\n(${tenkenKensaTotalCount}工数)`;
        }

        // 通常の時間表示
        return `${value}h`;
      }
    }
  },
  scales: {
    x: { stacked: true },
    y: { stacked: true, beginAtZero: true }
  }
};

// ▼ 件数グラフのオプション
const countOptions = {
  responsive: true,
  plugins: {
    legend: { position: 'top' },
    datalabels: {
      anchor: 'end',
      align: 'end',
      color: 'black',
      formatter: (value) => {
        if (value === 0) return '';
        return `${value}件`;
      }
    }
  },
  scales: {
    x: { stacked: true },
    y: { stacked: true, beginAtZero: true }
  }
};

new Chart(document.getElementById('timeChart').getContext('2d'), {
  type: 'bar',
  data: { labels: labels, datasets: timeDatasets },
  options: timeOptions,
  plugins: [ChartDataLabels]
});

new Chart(document.getElementById('countChart').getContext('2d'), {
  type: 'bar',
  data: { labels: labels, datasets: countDatasets },
  options: countOptions,
  plugins: [ChartDataLabels]
});
</script>
</body>
</html>
